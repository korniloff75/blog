<style>
input[type="text"], input[type="password"], select {
	width: 100%;
	max-width: 500px;
}
.uk-accordion-title {
	cursor: pointer;
}
body>#logWrapper {
	margin-left: 225px;
}
*[contenteditable="true"]{
	background-color: rgba(0, 0, 255, 0.151);
	outline: 1px solid blue;
	outline-offset: -1px;
}
*[contenteditable="true"]:hover{
	background-color: rgba(0, 0, 255, 0.055);
	outline: 1px solid blue;
	outline-offset: -1px;
}
*[contenteditable="true"]:focus{
	background-color: transparent;
	outline: 1px solid red;
	outline-offset: -1px;
}
</style>

<!-- <script src="/modules/ckeditor_plus/ckeditor/ckeditor.js"></script> -->
<!-- <script src="https://cdn.ckeditor.com/4.7.3/standard/ckeditor.js"></script> -->
<script src="/modules/ckeditor_4.5.8_standard/ckeditor/ckeditor.js"></script>


<hr>
<h2>Глобальные настройки</h2>

<div id="kff_sts" class="uk-section .uk-section-primary uk-padding">
	<p class="box"><label>Префикс для модулей <input name="mds_prefix" type="text" value="<?= Basic::$cfg['mds_prefix']?>"></label></p>
	<p class="comment">Скрипт выбирает все модули с указанным префиксом. Например, папки искомых модулей должны называться как <b>kff_modulename</b>. Для выбора всех модулей из системы -- удалите префикс. После любого изменения префикса -- перезагрузите страницу.</p>

	<p><label>Init Modules <input name="init_mods" type="checkbox" ></label></p>
	<p class="comment">Инициализация всех модулей. Системная.</p>


	<ul id="UIKit" data-group="uk" class="uk-list uk-list-striped uk-list-large">
		<li><label>Подключить UIKIT <input id="include_uikit" name="include_uikit" type="checkbox"></label>
			<p class="comment">Подключение библиотеки UIKIT на все страницы сайта</p>
		</li>
		<li><label>Подключить изображения <input name="include_picts" type="checkbox"></label>
			<h5>Применить стили UIKIT ко всем:</h5>
			<p class="comment">
				Подключённые теги будут динамически обрабатываться модулем.
			</p>

			<ul class="uk-list uk-list-striped">

				<li><label>Тегам <i>input/textarea/select</i> <input name="use_styles_input" type="checkbox"></label></li>
				<li><label>Тегам <i>ul</i> <input name="use_styles_ul" type="checkbox"></label></li>

			</ul>
		</li>

	</ul>

	<button class="uk-button">Сохранить настройки</button>
</div>


<script>
'use strict';
// kff.checkLib('jQuery')
// .then($=>{
// UIkit.util.ready(()=>{
$(()=>{

	var U= UIkit.util,
	cfg= <?=json_encode(Basic::$cfg)?>,
	$content= $('.content');

	ajaxRender();

	$content.find('input[type=checkbox]')
	.each((ind,i)=>{
		i.classList.add('uk-checkbox');

		i.group= i.closest('[data-group]')? i.closest('[data-group]').getAttribute('data-group'): null;
		i.checked= i.group? cfg[i.group]&&cfg[i.group][i.name]: cfg[i.name];
		if(i.hasAttribute('data-unchecked')) i.checked= false;
		console.log(i, i.checked, /* cfg */);
	});

	// *Сохр глоб. настроек
	$('#kff_sts, #installModules').on('change', 'input', $e=>{
		var $t= $($e.target);
		// console.log($t.prop('checked'));
		if(!$t.length) return;

		var val= $t.val() === 'on' ? $t.prop('checked') : $t.val();

		var $include_uikit = $('#include_uikit'),
			send_data = {
				type: 'global',
				group: $t.prop('group'),
				name: $t.prop('name'),
				val: val,
			};

		if(!$include_uikit.prop('checked')) {
			$include_uikit.closest('ul').find('input[type=checkbox]').prop({checked:0});
			send_data.disable = 1;
		}

		// todo
		// *installAll
		var $installAll= $('input[name=installAll]');
		console.log($installAll.prop('checked'));
		if($installAll.prop('checked')) {
			send_data.val= {installAll:1};
			// $installAll.closest('ul').find('input[type=checkbox]').prop({checked:1});
			$installAll.closest('ul').find('input[type=checkbox]').each((ind,i)=>{
				if(i === $installAll[0]) return;

				i.checked = 1;
				send_data.val[i.name] = 1;
			});

		}

		saveSTS(send_data);
	});

	function saveSTS (send_data) {
		$.post('', send_data).then((response, status)=>{
			console.log(document.documentElement);
			// $('.log').html($(response).find('.log'));
			// document.documentElement.innerHTML = response;
			ajaxRender(response);
		});
	}


	/**
	 * @param {jq} $t form element
	 * @param {string} method 'html' || 'val'
	 */
	function saveINI ($t, method) {
		$.post('',{
			ini_path: $t.closest('li.uk-open').find('h4').data('ini-path'),
			name: $t.prev().text().trim(),
			val: $t[method](),
		}).then((response, status)=>{
			// console.log();
			/* $('<div/>').insertAfter($e.currentTarget)
			.html($(response).find('pre.log')); */

			var lis = U.$$('#mds_sts>li');

			localStorage.setItem('open', lis.indexOf(U.$('#mds_sts>li.uk-open')));

			// console.log(U.$('.uk-open'));
			// document.documentElement.innerHTML = response;

			ajaxRender(response);
		});
	}

	function ajaxRender (response) {
		if(response) {
			$content.html($(response).find('.content'));
			$('.log').html($(response).find('.log'));
		}

		var open = localStorage.getItem('open') ;
		console.log(open);
		// *Открытый элемент
		(
			open && U.$$('#mds_sts>li')[open]
			|| U.$('#mds_sts>li.uk-open')
		).classList.add('uk-open');

		// *Украшения
		U.$$('.content input[type=checkbox]').forEach(i=>i.classList.add('uk-checkbox'));

		// *Сохр настроек модулей
		// console.log($('#mds_sts'));
		var contentHtml,
			$mds_sts = $('#mds_sts');

		$mds_sts.on('focus', 'div', $e=>{
			var $t= $($e.target);
			if(!$t.length) return;

			contentHtml= $t.html();
		});

		$mds_sts.on('blur', 'div', $e=>{
			var $t= $($e.target);
			if(!$t.length) return;

			if(contentHtml !== $t.html())
				saveINI($t, 'html');
		});

		$mds_sts.on('change', 'input,textarea', $e=>{
			var $t= $($e.target);
			if(!$t.length) return;

			saveINI($t, 'val');
		});
	}
});

CKEDITOR.inlineAll();
</script>